// ===================================
// ğŸ›¡ï¸ src/lib/subscription-middleware.ts
// ===================================
import { NextRequest, NextResponse } from 'next/server';
import { authenticateRequest } from './api-auth';
import { checkUserLimit, incrementAppointmentUsage } from './subscription-utils';

/**
 * Middleware ×œ×‘×“×™×§×ª ×”×’×‘×œ×•×ª ×‘××¢×¨×›×ª ×”×× ×•×™×™× - ×’×¨×¡×” ××ª×•×§× ×ª
 */
export async function checkSubscriptionLimit(
  request: NextRequest,
  action: 'create_business' | 'create_appointment' | 'send_sms'
): Promise<NextResponse | null> {
  try {
    // ××™××•×ª ××©×ª××©
    const { user, error: authError } = await authenticateRequest();
    if (authError || !user) {
      return NextResponse.json({ error: '×œ× ××•×¨×©×”' }, { status: 401 });
    }

    // ×‘×“×™×§×ª ××’×‘×œ×”
    const limitCheck = await checkUserLimit(user.id, action);
    
    if (!limitCheck.allowed) {
      return NextResponse.json(
        { 
          error: limitCheck.reason,
          limit_reached: true,
          action_required: 'upgrade'
        }, 
        { status: 403 }
      );
    }

    // ×× ×”×›×œ ×‘×¡×“×¨, ×”×—×–×¨ null (×”××©×š ×œ×¤×¢×•×œ×” ×”×¨×’×™×œ×”)
    return null;
  } catch (error) {
    console.error('Error in subscription middleware:', error);
    return NextResponse.json(
      { error: '×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×•×ª' }, 
      { status: 500 }
    );
  }
}

/**
 * ×¢×“×›×•×Ÿ ×©×™××•×© ××—×¨×™ ×™×¦×™×¨×ª ×ª×•×¨
 */
export async function updateUsageAfterAction(userId: string, action: string) {
  if (action === 'create_appointment') {
    await incrementAppointmentUsage(userId);
  }
}